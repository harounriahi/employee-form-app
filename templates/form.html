<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ASSURANCES BIAT - Demande d'accès système</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/biat-form.css') }}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background: linear-gradient(120deg, #e0e6ed 0%, #dce9e6 100%);
      min-height: 100vh;
    }

    .biat-glass-header {
      background: rgba(42, 90, 78, 0.93);
      border-radius: 0px;
      box-shadow: 0 10px 32px rgba(44, 62, 80, 0.19);
      padding: 24px 36px 26px 36px;
      margin: 0 auto 38px auto;
      max-width: 100%;
      backdrop-filter: blur(8px);
      position: relative;
      border-bottom: 4px solid #256029;
    }

    .biat-header-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .biat-header-title {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      font-size: 2.2rem;
      font-weight: 700;
      color: #ffffff;
      letter-spacing: 1.4px;
      text-shadow: 0 2px 6px rgba(44,62,80,0.2);
      margin-top: 12px;
    }

    .biat-logo {
      height: 65px;
      margin-bottom: 12px;
      filter: drop-shadow(0 2px 8px #0a371a33);
    }

    .biat-header-user {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 1.08rem;
      font-weight: 500;
      color: #e9fbe9;
      position: absolute;
      top: 20px;
      right: 36px;
    }

    .user-email {
      background: rgba(255,255,255,0.13);
      padding: 7px 19px;
      border-radius: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(44,62,80,0.06);
      color: #f1f1f1;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .logout-btn {
      background: linear-gradient(135deg, #ff7c7c 0%, #f06292 100%);
      color: #fff !important;
      border-radius: 12px;
      padding: 8px 24px;
      font-size: 1.08rem;
      border: none;
      text-decoration: none;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(44,62,80,0.11);
      transition: background 0.18s, color 0.18s, transform 0.18s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logout-btn:hover {
      background: linear-gradient(135deg, #c62828 0%, #ad1457 100%);
      color: #fff !important;
      transform: translateY(-2px) scale(1.04);
    }

    .biat-nav {
      display: flex;
      gap: 20px;
      margin-top: 28px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .biat-nav-btn {
      background: linear-gradient(90deg, #388e3c 0%, #8bc34a 100%);
      color: #fff;
      font-size: 1.17rem;
      font-weight: 600;
      border-radius: 14px;
      padding: 16px 34px;
      text-decoration: none;
      box-shadow: 0 2px 13px rgba(44,62,80,0.12);
      letter-spacing: 0.8px;
      transition: background 0.22s, color 0.22s, transform 0.19s;
      border: none;
      outline: none;
      display: flex;
      align-items: center;
      gap: 13px;
    }

    .biat-nav-btn.active,
    .biat-nav-btn:focus,
    .biat-nav-btn:hover {
      background: linear-gradient(90deg, #256029 0%, #43a047 100%);
      color: #fff;
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 4px 20px rgba(44,62,80,0.18);
      text-decoration: none;
    }

    @media (max-width: 900px) {
      .biat-header-title {font-size: 1.3rem;}
      .biat-nav-btn {font-size: 1rem; padding: 10px 16px;}
      .biat-nav {gap: 10px;}
      .biat-header-user {font-size: 1rem;}
      .user-email {padding: 6px 9px;}
    }

    @media (max-width: 600px) {
      .biat-header-title {font-size: 1.02rem;gap:7px;}
      .biat-nav {flex-direction: column;gap:11px;}
      .biat-nav-btn {padding: 10px 10px;}
      .user-email {font-size: 0.95rem;}
    }
  </style>
</head>

<body>
  <div class="biat-glass-header">
    <div class="biat-header-top">
      <div class="biat-header-title">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="BIAT" class="biat-logo" />
        <div>DEMANDE D'ACCÈS<br>SYSTÈME</div>
        <hr style="width: 80px; border-top: 3px solid #8bc34a; margin: 14px auto 0 auto;">
      </div>
    </div>
    <div class="biat-header-user">
      <span class="user-email"><i class="fas fa-user-circle"></i> {{ session.get('user') or 'Invité' }}</span>
      <a href="{{ url_for('logout') }}" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Déconnexion
      </a>
    </div>
    <nav class="biat-nav">
      <a href="{{ url_for('dashboard') }}" class="biat-nav-btn"><i class="fas fa-home"></i> Accueil</a>
      <a href="{{ url_for('form') }}" class="biat-nav-btn"><i class="fas fa-edit"></i> Formulaire</a>
      <a href="{{ url_for('mes_demandes') }}" class="biat-nav-btn"><i class="fas fa-list-alt"></i> Mes demandes</a>
      {% if session.get('role') == 'informatique' %}
        <a href="{{ url_for('register') }}" class="biat-nav-btn"><i class="fas fa-user-plus"></i> Ajouter un utilisateur</a>
      {% endif %}
    </nav>
  </div>

  <div class="biat-container">
    <form method="POST" action="{{ url_for('submit') }}">
      <!-- Section Informations de base -->
      <div class="biat-form-section">
        <h3 class="biat-section-title">Informations générales</h3>
        <div class="biat-form-group">
          <label class="biat-label biat-required">Objet de la demande</label>
          <div class="biat-radio-group" style="flex-direction: column; gap: 8px;">
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Octroi de nouveaux droits" />
              Octroi de nouveaux droits
            </label>
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Modification - ajout" />
              Modification - ajout
            </label>
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Modification - suppression" />
              Modification - suppression
            </label>
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Mutation" />
              Mutation
            </label>
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Départ" />
              Départ
            </label>
          </div>
        </div>
        <div class="biat-form-group">
          <label class="biat-label biat-required">Date de la demande</label>
          <input type="date" id="date-demande" name="date_demande" class="biat-input" readonly />
        </div>
        <div class="biat-form-group">
          <label class="biat-label">Demandeur</label>
          <input
            type="text"
            class="biat-input"
            value="{{ demandeur }}"
            readonly
            style="background-color: #f5f5f5"
          />
        </div>
        <div class="row">
          <!-- Département -->
          <div class="col-md-4">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Département</label>
              <select id="departement" name="departement" class="biat-input" onchange="updatePole()">
                <option value="">-- Sélectionner un département --</option>
                <option value="Vie">Vie</option>
                <option value="Santé">Santé</option>
                <option value="Non-Vie">Non-Vie</option>
                <option value="Réseaux et Animation Commerciale">Réseaux et Animation Commerciale</option>
                <option value="Bancassurance">Bancassurance</option>
                <option value="Division Marketing Communication et Parcours Clients">Division Marketing Communication et Parcours Clients</option>
                <option value="Comptabilité">Comptabilité</option>
                <option value="Recouvrement">Recouvrement</option>
                <option value="Budget et Contrôle de gestion">Budget et Contrôle de gestion</option>
                <option value="SI">SI</option>
                <option value="MOA et Organisation">MOA et Organisation</option>
                <option value="RH et Moyens Généraux">RH et Moyens Généraux</option>
                <option value="Juridique et CTX">Juridique et CTX</option>
                <option value="Financier">Financier</option>
              </select>
            </div>
          </div>
        
          <!-- Produit -->
          <div class="col-md-4">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Produit</label>
              <select id="produit" name="produit" class="biat-input">
                <option value="">-- Sélectionner un produit --</option>
              </select>
            </div>
          </div>
        
          <!-- Pôle -->
          <div class="col-md-4">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Pôle</label>
              <input type="text" id="pole" name="pole" class="biat-input" readonly placeholder="Automatique..." />
            </div>
          </div>
        </div>
        
        
        

      <!-- Section Utilisateur -->  
      <div class="biat-form-section">
        <h3 class="biat-section-title">Informations utilisateur</h3>
        <div class="biat-form-group">
          <label class="biat-label biat-required">Type de collaborateur</label>
          <div class="biat-radio-group">
            <label class="biat-radio">
              <input type="radio" name="collaborator_type" value="interne" checked />
              Interne
            </label>
            <label class="biat-radio">
              <input type="radio" name="collaborator_type" value="stagiaire" onchange="toggleStageCard()" />
              Stagiaire
            </label>
            <label class="biat-radio">
              <input type="radio" name="collaborator_type" value="externe" />
              Prestataire/Externe
            </label>
          </div>
        </div>
        <div id="stageCard" style="display: none;">
          <div class="biat-form-group">
            <label class="biat-label">Date de début de stage</label>
            <input type="date" name="date_debut_stage" class="biat-input" style="width: auto;" />
          </div>
          <div class="biat-form-group">
            <label class="biat-label">Date de fin de stage</label>
            <input type="date" name="date_fin_stage" class="biat-input" style="width: auto;" />
          </div>
        </div>
        <div class="biat-form-group">
          <label class="biat-label biat-required">Nom complet</label>
          <input type="text" name="nom_complet" class="biat-input" placeholder="Nom & Prénom" />
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Matricule</label>
              <input type="text" name="matricule" class="biat-input" />
            </div>
          </div>
          <div class="col-md-6">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Email professionnel</label>
              <input type="email" name="email" class="biat-input" />
            </div>
          </div>
        </div>
      </div>

      

      <!-- Section Systèmes -->
      <div class="biat-form-section">
        <h3 class="biat-section-title">Systèmes d'information</h3>
        <p class="text-muted">Sélectionnez les systèmes concernés et les environnements (TEST/PROD)</p>
        <div id="sousType"></div>
      </div>

      <!-- Section Accès Réseaux -->
      <div class="biat-form-section">
        <h3 class="biat-section-title">Accès réseaux</h3>
        <div class="biat-checkbox-group">
          <label class="biat-checkbox">
            <input type="checkbox" name="network_access[]" value="internet" />
            Accès Internet
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="network_access[]" value="messagerie" />
            Messagerie externe
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="network_access[]" value="session" />
            Session Windows
          </label>
        </div>
        <div class="biat-form-group" style="margin-top: 20px;">
          <label class="biat-label">Accès partagés (précisez si nécessaire)</label>
          <input type="text" name="acces_partages" class="biat-input" />
        </div>
      </div>

      <!-- Submit button only (signature section removed) -->
      <div class="biat-form-section" style="text-align:center;">
        <button type="submit" class="biat-submit-btn">
          <i class="fas fa-paper-plane"></i> Envoyer la demande
        </button>
      </div>
    </form>
  </div>

  <script>
    const departementData = {
      "Vie": {
        pole: "Assurance de Personnes",
        produit: ["Epargne", "Prévoyance"],
        systemes: {
          "ARIMA": ["Profil 1", "Profil 2", "Profil 3"]
        }
      },
      "Santé": {
        pole: "Assurance de Personnes",
        produit: ["Santé"],
        systemes: {
          "AGORA": ["Profil 1", "Profil 2", "Profil 3"],
          "ESP ASS": ["Profil 1", "Profil 2", "Profil 3"],
          "SQL Santé": ["Profil 1", "Profil 2", "Profil 3"]
        }
      },
      "Non-Vie": {
        pole: "Assurance Dommages et Responsabilités",
        produit: ["Automobile", "IRDS", "Incendie", "Risques Divers", "Responsabilité Civile", "Transports", "Accident Corporel", "Assistances", "Construction"],
        systemes: {
          "ARIMA": ["Profil 1", "Profil 2", "Profil 3"]
        }
      },
      "Réseaux et Animation Commerciale": {
        pole: "Commercial",
        produit: ["Commercial"],
        systemes: { "ARIMA": ["Profil 1", "Profil 2", "Profil 3"] }
      },
      "Bancassurance": {
        pole: "Commercial",
        produit: ["Commercial"],
        systemes: { "ARIMA": ["Profil 1", "Profil 2", "Profil 3"] }
      },
      "Division Marketing Communication et Parcours Clients": {
        pole: "Commercial",
        produit: ["Commercial"],
        systemes: { "ARIMA": ["Profil 1", "Profil 2", "Profil 3"] }
      },
      "Comptabilité": {
        pole: "Comptabilité, contrôle de gestion et Recouvrement",
        produit: ["Comptabilité"],
        systemes: { "SAGE": ["Profil 1", "Profil 2", "Profil 3"] }
      },
      "Recouvrement": {
        pole: "Comptabilité, contrôle de gestion et Recouvrement",
        produit: ["Recouvrement"],
        systemes: { "SAGE": ["Profil 1", "Profil 2", "Profil 3"] }
      },
      "Budget et Contrôle de gestion": {
        pole: "Comptabilité, contrôle de gestion et Recouvrement",
        produit: ["Budget/CG"],
        systemes: { "SAGE": ["Profil 1", "Profil 2", "Profil 3"] }
      },
      "SI": { pole: "Transformation et Organisation", produit: ["SI"], systemes: { } },
      "MOA et Organisation": { pole: "Transformation et Organisation", produit: ["MOA"], systemes: { } },
      "RH et Moyens Généraux": { pole: "Financier, RH, Logistique et Contentieux", produit: ["RH"], systemes: { "SAGE": ["Profil 1", "Profil 2", "Profil 3"] } },
      "Juridique et CTX": { pole: "Financier, RH, Logistique et Contentieux", produit: ["Juridique"], systemes: { "SAGE": ["Profil 1", "Profil 2", "Profil 3"] } },
      "Financier": { pole: "Financier, RH, Logistique et Contentieux", produit: ["Financier"], systemes: { "SAGE": ["Profil 1", "Profil 2", "Profil 3"] } }
    };

  
    function updatePole() {
      const departementSelect = document.getElementById("departement");
      const poleInput = document.getElementById("pole");
      const produitSelect = document.getElementById("produit");
      const sousTypeDiv = document.getElementById("sousType");

      const selectedDep = departementSelect.value;
      const data = departementData[selectedDep];

      // mettre à jour le pôle
      poleInput.value = data ? data.pole : "";

      // mettre à jour le produit
      produitSelect.innerHTML = '<option value="">-- Sélectionner un produit --</option>';
      if (data && data.produit) {
        data.produit.forEach(p => {
          produitSelect.innerHTML += `<option value="${p}">${p}</option>`;
        });
      }

      // mettre à jour les systèmes
      sousTypeDiv.innerHTML = "";
      if (data && data.systemes) {
        Object.entries(data.systemes).forEach(([system, profiles]) => {
          const card = document.createElement("div");
          card.className = "biat-system-card mb-3";

          const header = document.createElement("div");
          header.className = "biat-system-header";
          header.innerHTML = `<strong>${system}</strong>`;
          card.appendChild(header);

          profiles.forEach(profile => {
            const row = document.createElement("div");
            row.className = "d-flex align-items-center justify-content-between mb-2";
            row.innerHTML = `
              <label class="me-3">${profile}</label>
              <div class="d-flex gap-3">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" name="profils_env[${system}][${profile}][]" value="TEST">
                  <label class="form-check-label">TEST</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" name="profils_env[${system}][${profile}][]" value="PROD">
                  <label class="form-check-label">PROD</label>
                </div>
              </div>
            `;
            card.appendChild(row);
          });

          sousTypeDiv.appendChild(card);
        });
      }
    }

  </script>
  

  <!-- Pass profiles_dict as JSON to JS -->
  <script>
    // This must be rendered by Flask as JSON!
    const profilesDict = {{ profiles_dict | tojson }};
    const systemsList = Object.values(profilesDict)[0] ? Object.keys(Object.values(profilesDict)[0]) : [];

    function updateListe() {
      const sousTypeDiv = document.getElementById("sousType");
      sousTypeDiv.innerHTML = "";

      const checkedBranches = Array.from(document.querySelectorAll('input[name="branches[]"]:checked')).map(b => b.value);

      if (checkedBranches.length === 0) {
        sousTypeDiv.innerHTML = `<div class="alert alert-info">Veuillez sélectionner au moins une branche pour voir les systèmes et profils disponibles.</div>`;
        return;
      }

      checkedBranches.forEach(branche => {
        const branchProfilesBySystem = profilesDict[branche];
        if (!branchProfilesBySystem) return;

        Object.entries(branchProfilesBySystem).forEach(([system, profiles]) => {
          const appId = `${branche}_${system}`.replace(/\s+/g, "_");
          const card = document.createElement("div");
          card.className = "biat-system-card mb-3";

          const header = document.createElement("div");
          header.className = "biat-system-header";
          header.innerHTML = `<strong>${branche} - <span style="font-weight:normal;color:#256029">${system}</span></strong>`;
          card.appendChild(header);

          profiles.forEach(profile => {
            const row = document.createElement("div");
            row.className = "d-flex align-items-center justify-content-between mb-2";
            row.innerHTML = `
              <label class="me-3">${profile}</label>
              <div class="d-flex gap-3">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" name="profils_env[${branche}][${system}][${profile}][]" value="TEST" id="${appId}_${profile}_test">
                  <label class="form-check-label" for="${appId}_${profile}_test">TEST</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" name="profils_env[${branche}][${system}][${profile}][]" value="PROD" id="${appId}_${profile}_prod">
                  <label class="form-check-label" for="${appId}_${profile}_prod">PROD</label>
                </div>
              </div>
            `;
            card.appendChild(row);
          });

          sousTypeDiv.appendChild(card);
        });
      });
    }

    function toggleStageCard() {
      const stageCard = document.getElementById("stageCard");
      const isStagiaire = document.querySelector(
        'input[name="collaborator_type"][value="stagiaire"]'
      ).checked;
      stageCard.style.display = isStagiaire ? "block" : "none";
    }

    document.addEventListener("DOMContentLoaded", function () {
      const today = new Date().toISOString().split("T")[0];
      const dateInput = document.getElementById("date-demande");
      if (dateInput) {
        dateInput.value = today;
      }
      updateListe();
      document.querySelectorAll('input[name="branches[]"]').forEach((checkbox) => {
        checkbox.addEventListener("change", updateListe);
      });
    });
  </script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>