<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ASSURANCES BIAT - Demande d'accès système</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/biat-form.css') }}">
</head>
<body>
  <div class="biat-container">
    <div class="biat-header">
      <div class="biat-header-left">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Assurances BIAT" class="biat-logo" />
      </div>
      <div class="biat-header-center">
        <h1 class="biat-title">DEMANDE D'ACCÈS SYSTÈME</h1>
        <p class="biat-subtitle">Formulaire de gestion des droits d'accès</p>
      </div>
      <div class="biat-header-right" style="display: flex; align-items: center; gap: 15px; color: var(--white); font-weight: 600;">
        <span>{{ session.get('user') or 'Invité' }}</span>
        <a href="{{ url_for('logout') }}" class="logout-btn">Déconnexion</a>
      </div>
    </div>

    <form method="POST" action="{{ url_for('submit') }}">
      <!-- Section Informations de base -->
      <div class="biat-form-section">
        <h3 class="biat-section-title">Informations générales</h3>
        <div class="biat-form-group">
          <label class="biat-label biat-required">Objet de la demande</label>
          <div class="biat-radio-group" style="flex-direction: column; gap: 8px;">
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Octroi de nouveaux droits" />
              Octroi de nouveaux droits
            </label>
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Modification - ajout" />
              Modification - ajout
            </label>
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Modification - suppression" />
              Modification - suppression
            </label>
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Mutation" />
              Mutation
            </label>
            <label class="biat-radio">
              <input type="radio" name="objet_demande" value="Départ" />
              Départ
            </label>
          </div>
        </div>
        <div class="biat-form-group">
          <label class="biat-label biat-required">Date de la demande</label>
          <input type="date" id="date-demande" name="date_demande" class="biat-input" readonly />
        </div>
        <div class="biat-form-group">
          <label class="biat-label">Demandeur</label>
          <input
            type="text"
            class="biat-input"
            value="{{ demandeur }}"
            readonly
            style="background-color: #f5f5f5"
          />
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Département</label>
              <input type="text" name="departement" class="biat-input" placeholder="Ex: Systèmes d'information" />
            </div>
          </div>
          <div class="col-md-6">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Pôle</label>
              <input type="text" name="pole" class="biat-input" placeholder="Ex: Back Office" />
            </div>
          </div>
        </div>
      </div>

      <!-- Section Utilisateur -->
      <div class="biat-form-section">
        <h3 class="biat-section-title">Informations utilisateur</h3>
        <div class="biat-form-group">
          <label class="biat-label biat-required">Type de collaborateur</label>
          <div class="biat-radio-group">
            <label class="biat-radio">
              <input type="radio" name="collaborator_type" value="interne" checked />
              Interne
            </label>
            <label class="biat-radio">
              <input type="radio" name="collaborator_type" value="stagiaire" onchange="toggleStageCard()" />
              Stagiaire
            </label>
            <label class="biat-radio">
              <input type="radio" name="collaborator_type" value="externe" />
              Prestataire/Externe
            </label>
          </div>
        </div>
        <div id="stageCard" style="display: none;">
          <div class="biat-form-group">
            <label class="biat-label">Date de début de stage</label>
            <input type="date" name="date_debut_stage" class="biat-input" style="width: auto;" />
          </div>
          <div class="biat-form-group">
            <label class="biat-label">Date de fin de stage</label>
            <input type="date" name="date_fin_stage" class="biat-input" style="width: auto;" />
          </div>
        </div>
        <div class="biat-form-group">
          <label class="biat-label biat-required">Nom complet</label>
          <input type="text" name="nom_complet" class="biat-input" placeholder="Nom & Prénom" />
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Matricule</label>
              <input type="text" name="matricule" class="biat-input" />
            </div>
          </div>
          <div class="col-md-6">
            <div class="biat-form-group">
              <label class="biat-label biat-required">Email professionnel</label>
              <input type="email" name="email" class="biat-input" />
            </div>
          </div>
        </div>
      </div>

      <!-- Section Branches -->
      <div class="biat-form-section">
        <h3 class="biat-section-title">Branches concernées</h3>
        <div class="biat-checkbox-group">
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="AUTO" />
            AUTO
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="IARDS" />
            IARDS
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="Transport" />
            Transport
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="Santé" />
            Santé
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="Epargne" />
            Epargne
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="Prévoyance" />
            Prévoyance
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="Comptabilité" />
            Comptabilité
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="Recouvrement" />
            Recouvrement
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="branches[]" value="RH" />
            RH
          </label>
        </div>
      </div>

      <!-- Section Systèmes -->
      <div class="biat-form-section">
        <h3 class="biat-section-title">Systèmes d'information</h3>
        <p class="text-muted">Sélectionnez les systèmes concernés et les environnements (TEST/PROD)</p>
        <div id="sousType"></div>
      </div>

      <!-- Section Accès Réseaux -->
      <div class="biat-form-section">
        <h3 class="biat-section-title">Accès réseaux</h3>
        <div class="biat-checkbox-group">
          <label class="biat-checkbox">
            <input type="checkbox" name="network_access[]" value="internet" />
            Accès Internet
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="network_access[]" value="messagerie" />
            Messagerie externe
          </label>
          <label class="biat-checkbox">
            <input type="checkbox" name="network_access[]" value="session" />
            Session Windows
          </label>
        </div>
        <div class="biat-form-group" style="margin-top: 20px;">
          <label class="biat-label">Accès partagés (précisez si nécessaire)</label>
          <input type="text" name="acces_partages" class="biat-input" />
        </div>
      </div>

      <!-- Section Signatures -->
      <div class="biat-form-section">
        <div class="biat-signature-section">
          <div class="biat-signature">
            <p>Signature Responsable</p>
            <div class="biat-signature-line"></div>
          </div>
          <div class="biat-signature">
            <p>Signature Réalisateur</p>
            <div class="biat-signature-line"></div>
          </div>
        </div>
        <button type="submit" class="biat-submit-btn">
          <i class="fas fa-paper-plane"></i> Envoyer la demande
        </button>
      </div>
    </form>
  </div>

  <script>
    // Return a list of "profile1", "profile2", ... with a random count (3-5) per branch
    function getRandomProfiles() {
      const count = Math.floor(Math.random() * 3) + 3; // 3, 4 or 5
      let arr = [];
      for(let i=1; i<=count; i++) arr.push('profile'+i);
      return arr;
    }

    function updateListe() {
      const sousTypeDiv = document.getElementById("sousType");
      sousTypeDiv.innerHTML = "";

      const checkedBranches = Array.from(document.querySelectorAll('input[name="branches[]"]:checked')).map(b => b.value);

      if (checkedBranches.length === 0) {
        sousTypeDiv.innerHTML = `<div class="alert alert-info">Veuillez sélectionner au moins une branche pour voir les systèmes et profils disponibles.</div>`;
        return;
      }

      checkedBranches.forEach(branche => {
        const appId = `${branche}`.replace(/\s+/g, "_");
        const card = document.createElement("div");
        card.className = "biat-system-card mb-3";

        const header = document.createElement("div");
        header.className = "biat-system-header";
        header.innerHTML = `<strong>${branche}</strong>`;
        card.appendChild(header);

        // Random profiles for this branch
        const profiles = getRandomProfiles();

        profiles.forEach(profile => {
          const row = document.createElement("div");
          row.className = "d-flex align-items-center justify-content-between mb-2";
          row.innerHTML = `
            <label class="me-3">${profile}</label>
            <div class="d-flex gap-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="profils_env[${branche}][${profile}][]" value="TEST" id="${appId}_${profile}_test">
                <label class="form-check-label" for="${appId}_${profile}_test">TEST</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="profils_env[${branche}][${profile}][]" value="PROD" id="${appId}_${profile}_prod">
                <label class="form-check-label" for="${appId}_${profile}_prod">PROD</label>
              </div>
            </div>
          `;
          card.appendChild(row);
        });

        sousTypeDiv.appendChild(card);
      });
    }

    function toggleStageCard() {
      const stageCard = document.getElementById("stageCard");
      const isStagiaire = document.querySelector(
        'input[name="collaborator_type"][value="stagiaire"]'
      ).checked;
      stageCard.style.display = isStagiaire ? "block" : "none";
    }

    document.addEventListener("DOMContentLoaded", function () {
      // Auto-fill today's date
      const today = new Date().toISOString().split("T")[0];
      const dateInput = document.getElementById("date-demande");
      if (dateInput) {
        dateInput.value = today;
      }
      updateListe();
      document.querySelectorAll('input[name="branches[]"]').forEach((checkbox) => {
        checkbox.addEventListener("change", updateListe);
      });
    });
  </script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>